<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <!--    <link href="../css/css.css" rel="stylesheet" type="text/css"/>-->
    <!--    <link href="../css/style.css" rel="stylesheet" type="text/css"/>-->
    <script type="text/javascript" src="../js/jquery.js"></script>
    <script type="text/javascript" src="../js/jquery-ui.min.js"></script>
    <script type="text/javascript" src="../js/hi-utils.js"></script>
    <link rel="stylesheet" href="../css/jquery-ui.min.css">
    <link rel="stylesheet" type="text/css" href="../css/hi-main.css"/>
    <style type="text/css">

    </style>
    <script language=JavaScript>
        var currentType="mypost";
        $(function () {
            request = getRequest();
            currentType=request["type"];
            loadEnterpriseList(1);
            // console.log(currentType)
            if(currentType=="mypost"){
                $("#pageTitle").html("待我提报任务列表");
            }else if(currentType=="myposted"){
                $("#pageTitle").html("我提报过的任务列表");
            }else if(currentType=="mycheck"){
                $("#pageTitle").html("待我审批任务列表");
                $(".list-button").show();
            }else if(currentType=="mychecked"){
                $("#pageTitle").html("我审批过的任务列表");
            }
            $("#prePage").click(function () {
                if($("#currentPage").html()>1){
                    loadEnterpriseList(parseInt($("#currentPage").html())-1);
                }
            })
            $("#firstPage").click(function () {
                if($("#currentPage").html()>1){
                    loadEnterpriseList(1);
                }
            })
            $("#lastPage").click(function () {
                loadEnterpriseList($("#totalPage").html());
            })
            $("#nextPage").click(function () {
                console.log($("#currentPage").html())
                if($("#currentPage").html()<$("#totalPage").html()){
                    loadEnterpriseList(parseInt($("#currentPage").html())+1);
                }
            })
            $("#batchCheck").click(function () {
                var obj = $('[name="lineCheck"]');
                checkVal = [];
                for(k in obj){
                    if(obj[k].checked && obj[k].value != ""){
                        checkVal.push(obj[k].value);
                    }

                }
                checkFile(checkVal.join(","));
            })
            $("#lineCheckTogger").click(function () {
                var obj = $('[name="lineCheck"]');
                if($("#lineCheckTogger").is(":checked")){
                    for(i in obj){
                        obj[i].checked=true;
                    }
                }else{
                    for(i in obj){
                        obj[i].checked=false;
                    }
                }
            })
        })

        loadEnterpriseList= function(page) {
            var jsonParam="{page:"+page+",operateType:'"+currentType+"'}";

            $.ajax({
                type: "get",
                url: "/serverestimate/taskController/getTaskList",
                data: {jsonParam: jsonParam},
                async: true,
                success: function (data) {
                    if(data){
                        var sourceData = eval('(' + data + ')');
                        $("#totalPage").html(sourceData.totalPage)
                        $("#currentPage").html(sourceData.currentPage)
                        if (sourceData.list && sourceData.list.length > 0) {
                            addRows(sourceData.list)
                        }
                    }else{
                        $("#totalPage").html(0);
                        $("#tbMain").html("");
                    }
                },
                error: function (result) {
                    console.log("failed")
                }
            });
        }
        downloadModel=function(id){
            window.location="/serverestimate/taskController/downloadModel?topicId="+id;
        }
        readFile=function(taskSn){
            window.location="/serverestimate/taskController/downloadDataFile?taskSn="+taskSn;
        }
        uploadFile=function(taskSn){
            $("#taskSnHidden").val(taskSn);
            $("#dialog").show();
            $("#dialog").dialog({
                height:280,
                width:400,
                resizable: false,
                buttons: {
                    "提交": function() {
                        if(uploadDataFormFunction()){
                            loadEnterpriseList($("#currentPage").html());
                            $( this ).dialog( "close" );
                        }
                    },
                    "取消": function() {
                        $("#errorDiv").empty();
                        $( this ).dialog( "close" );
                    }
                }
            });
        }
        checkFile=function(taskSn){
            $("#taskSnHidden").val(taskSn);
            $("#dialogCheck").dialog({
                height:280,
                width:400,
                resizable: false,
                buttons: {
                    "提交": function() {
                        checkDataFunction(taskSn)
                        loadEnterpriseList($("#currentPage").html());
                        $( this ).dialog( "close" );
                    },
                    "取消": function() {
                        $("#errorDiv").empty();
                        $( this ).dialog( "close" );
                    }
                }
            });
        }

        uploadDataFormFunction=function () {
            if(!checkForm()){
                return false;
            }
            var formData=new FormData($("#uploadDataForm")[0]);
            $.ajax({
                type: "post",
                url: "/serverestimate/taskController/uploadFile",
                data:formData,
                async: true,
                cache: false,
                contentType: false,
                processData: false,
                success: function (data) {
                    if("success"==data){
                        loadEnterpriseList($("#currentPage").html());
                    }

                },
                error: function (result) {
                    alert("保存失败")
                }
            });
            return true;
        }
        checkDataFunction=function(taskSn){
            var checkFlag=$('input[name=checkFlag]:checked').val();
            var checkContent
            if($("#checkContent").val()){
                checkContent=$("#checkContent").val();
            }else{
                checkContent="";
            }
            var jsonParam = "{taskSn:'" + taskSn + "',checkType:'" + checkFlag + "',content:'"+$("#checkContent").val()+"'}";
            $.ajax({
                type: "get",
                url: "/serverestimate/taskController/checkTask",
                data: {jsonParam: jsonParam},
                async: true,
                success: function (data) {
                    if("success"==data){
                        $("#batchCheck").show();
                        loadEnterpriseList($("#currentPage").html());
                    }

                },
                error: function (result) {
                    alert("保存失败")
                }
            });
        }
        //验证form
        checkForm=function(){
            var goodInput=true;
            $("#errorDiv").empty();

            var file = $('#dataFile').get(0).files[0];
            if(!file){
                $("#errorDiv").append("<p>*【文件】不能为空</p>");
                goodInput=false;
            }else if(file.name.indexOf("xlsx")>=0||file.name.indexOf("xls")<=0){
                $("#errorDiv").append("<p>*【文件】必格式错误(需要xls格式)</p>");
                goodInput=false;
            }else if(file.size>20000000){
                $("#errorDiv").append("<p>*【文件】不能超过20M</p>");
                goodInput=false;
            }
            return goodInput;
        }
        addRows=function(topicList){
            var html  ="";
            for(var i=0;i<topicList.length;i++){
                var task=topicList[i];
                html +=     "<tr name='dataRow'>";
                html+="<td>"+"<input type='checkbox' name='lineCheck' value='"+task.taskSn+"'/>"+"</td>";
                html +=     "<td>" +(i+1)+ "</td>";
                html +=     "<td>" + task.title+ "</td>";
                html +=     "<td>" + new Date(task.dealDate).Format("yyyy-MM-dd") + "</td>";
                if(task.dealUserName!=undefined){
                html +=     "<td>" + task.dealUserName + "</td>";
                }else{
                    html += "<td>-</td>";
                }
                html +=     "<td>" + task.postUserName + "</td>";
                html +=     "<td>" + task.createUserName + "</td>";
                html +=     "<td>" + new Date(task.createDate).Format("yyyy-MM-dd hh:mm") + "</td>";
                html +=     "<td>";
                if(task.content){
                    html+="<a href='#' onclick='viewContent(\""+task.content+"\")'>备注</a>";
                }
                if(currentType=="mypost"){
                    html+="<a href='#' onclick='downloadModel(\""+task.topicId+"\")'>下载模板</a>";
                    html+="<a href='#' onclick='uploadFile(\""+task.taskSn+"\")'>上报数据</a>";
                }else if(currentType=="myposted"){
                    html+="<a href='#' onclick='downloadModel(\""+task.topicId+"\")'>下载模板</a>";
                    html+="<a href='#' onclick='readFile(\""+task.taskSn+"\")'>查看数据</a>";
                }else if(currentType=="mycheck"){
                    html+="<a href='#' onclick='readFile(\""+task.taskSn+"\")'>查看数据</a>";
                    html+="<a href='#' onclick='checkFile(\""+task.taskSn+"\")'>审批</a>";
                }else if(currentType=="mychecked"){
                    html+="<a href='#' onclick='readFile(\""+task.taskSn+"\")'>查看数据</a>";
                }
                html+="</td>";
                html += "</tr>";
            }
            $("#tbMain").html(html);
        }
        viewContent=function (content) {
            $("#infoDialog p").html(content)
            $("#infoDialog").dialog({
                height:200,
                width:400,
                resizable: false,
                buttons: {
                    "关闭": function() {
                        $( this ).dialog( "close" );
                    }
                }
            });
        }

    </script>
</head>
<body>
    <div class="toolbar">
        <span><h4 id="pageTitle">用户管理</h4></span>
    </div>
    <div class="list-button" style="display: none" ><span class="addBtn" id="batchCheck">批量审批</span></div>
    <div class="list-table">
        <table width="95%" align="center" >
            <tr >
                <th width="5%"><input type='checkbox' id='lineCheckTogger' /></th>
                <th width="5%">序号</th>
                <th width="20%">标题</th>
                <th width="10%">截止时间</th>
                <th width="10%">当前处理人</th>
                <th width="10%">提报者</th>
                <th width="10%">发布者</th>
                <th width="10%">创建时间</th>
                <th width="20%">操作</th>
            </tr>
            <tbody id="tbMain">
            </tbody>
        </table>
    </div>
    <div class="pagebutton">
        <span class="pageClass"><span id="currentPage">1</span>/<span id="totalPage">5</span></span>
        <a href="#" id="firstPage">首页</a>  <a href="#" id="prePage">上一页</a>
        <a id="nextPage" href="#">下一页</a>  <a id="lastPage" href="#" >末页</a>

    </div>
    <div id="dialog" title="上传数据" style="display: none">
        <div id="errorDiv" style="color:red"></div>
        <form id="uploadDataForm" enctype="multipart/form-data" >
            <input type="hidden" id="taskSnHidden" name="taskSn"/>
            <p>文件：
                <input id="dataFile" type="file" name="dataFile">
            </p>
            <p>备注内容：<textarea rows="5" cols="50" name="content" id="content"></textarea></p>
        </form>
    </div>
    <div id="dialogCheck" title="数据审批" style="display: none">

        <p>审批：
            <input type="radio" name="checkFlag" value="yes" checked="checked">同意
            <input type="radio" name="checkFlag" value="reject">驳回
        </p>
        <p>备注：<textarea rows="5" cols="50" name="checkContent" id="checkContent"></textarea></p>
    </div>

    <div id="infoDialog" style="display:none;" title="备注信息">
        <p align="left"></p>
    </div>
</body>
</html>
