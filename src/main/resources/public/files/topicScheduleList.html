<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <!--    <link href="../css/css.css" rel="stylesheet" type="text/css"/>-->
    <!--    <link href="../css/style.css" rel="stylesheet" type="text/css"/>-->
    <script type="text/javascript" src="../js/jquery.js"></script>
    <script type="text/javascript" src="../js/jquery-ui.min.js"></script>
    <script type="text/javascript" src="../js/hi-utils.js"></script>
    <link rel="stylesheet" href="../css/jquery-ui.min.css">
    <link rel="stylesheet" type="text/css" href="../css/hi-main.css"/>
    <script language=JavaScript>
        var topicId;
        var sourceData;
        $(function () {
            var request = getRequest();
            topicId=request["id"];
             freshList(1);
            $("#prePage").click(function () {
                if ($("#currentPage").html() > 1) {
                    freshList(parseInt($("#currentPage").html()) - 1);
                }
            })
            $("#firstPage").click(function () {
                if ($("#currentPage").html() > 1) {
                     freshList(1);
                }
            })
            $("#lastPage").click(function () {
                freshList($("#totalPage").html(), 4);
            })
            $("#nextPage").click(function () {
                if ($("#currentPage").html() < $("#totalPage").html()) {
                    freshList(parseInt($("#currentPage").html()) + 1);
                }
            })

        });

        freshList = function (page) {
            // var jsonParam = "{page:" + page + ",topicId:'"+topicId+"'}";
            $.ajax({
                type: "get",
                url: "/serverestimate/topicController/getScheduleByTopicId",
                data: {jsonParam: topicId},
                async: true,
                success: function (data) {
                    if (data) {
                        sourceData = eval('(' + data + ')');
                        addRows(sourceData)
                    } else {
                        $("#totalPage").html(0);
                        $("#tbMain").html("");
                    }
                },
                error: function (result) {
                    console.log("failed")
                }
            });
        }
        formatStatus=function(code){
            var result="提报";
            switch(code)
            {
                case '1':
                    result= "提报";
                    break;
                case '2':
                    result= "分公司审核";
                    break;
                case '3':
                    result= "总公司审核";
                    break;
                case '4':
                    result="完成";
                    break;
                default:
                    result="提报(驳回）";
            }
            return result;
        }
        addRows = function (entityList) {
            var html = "";
            for (var i = 0; i < entityList.length; i++) {
                var entity = entityList[i];
                if(entity.status>3){
                    html+="<tr   onmouseover='addclass(this)' onmouseout='removeclass(this)' style='background-color: #def1de;'>"
                }else if(entity.status==3){
                    html+="<tr  onmouseover='addclass(this)' onmouseout='removeclass(this)' style='background-color: #efefc8;'>"
                }else if(entity.status==2){
                    html+="<tr  onmouseover='addclass(this)' onmouseout='removeclass(this)' style='background-color: #f8d9c4;'>"
                }else{
                    html+="<tr  onmouseover='addclass(this)' onmouseout='removeclass(this)'>"
                }
                html += "<td>" + (i + 1) + "</td>";
                html += "<td>" + entity.companyName+ "</td>";
                html += "<td>" + entity.postUsername + "</td>";
                html += "<td>" + formatStatus(entity.status) + "</td>";
                html += "<td>" + ((typeof(entity.dealUsername) == "undefined")?'-': entity.dealUsername)+ "</td>";
                html += "<td>" ;
                if(entity.status<4){
                    html+="<a href='#' onclick='urgeCurrentUser(" +'"'+ entity.taskSn +'"' + ")'>催办当前执行人</a>"
                    +"<a href='#' onclick='urgePostUser(" +'"'+ entity.postUser +'"'+ ")'>催办提报人</a>"
                    +"<a href='#' onclick='changePostUser(" +'"'+ entity.taskSn +'"'+ ")'>更改处理人</a>" ;
                }
                html+="</td>";
                html += "</tr>";
            }
            $("#tbMain").html(html);
        }
        urgeCurrentUser=function (taskSn) {
            if(sourceData) {
                for (var i = 0; i < sourceData.length; i++) {
                    if(sourceData[i]&&taskSn==sourceData[i].taskSn){
                        if("01".indexOf(sourceData[i].status)>0){
                            emailToUsers(new Array(sourceData[i].dealUser),'POST')
                        }else if("23".indexOf(sourceData[i].status)>0){
                            emailToUsers(new Array(sourceData[i].dealUser),'CHECK')
                        }
                    }
                }
            }
            //emailToUsers(new Array(userId),'CHECK')
        }
        urgeAllCurrentUser=function () {
            if(sourceData) {
                var allCheckUser = new Array();
                var allPostUser=new Array();
                for (var i = 0; i < sourceData.length; i++) {
                    if (sourceData[i]&&sourceData[i].status>1&&sourceData[i].status<4) {
                        allCheckUser=allCheckUser.concat((sourceData[i].dealUser).split(","));
                    }else if(sourceData[i]&&(sourceData[i].status==0||sourceData[i].status==1)) {
                        allPostUser=allPostUser.concat((sourceData[i].dealUser).split(","));
                    }
                }
                if(allPostUser.length>0){
                    emailToUsers(allPostUser,'POST')
                }
                if(allCheckUser.length>0){
                    emailToUsers(allCheckUser,'CHECK')
                }

            }
        }
        urgePostUser=function (userId) {
            emailToUsers(new Array(userId),'POST')
        }
        formatUserName=function(username){
            var maxLength=4;
            var result=username;
            var space="　";
            if(username.length<maxLength){
                for(var i=username.length;i<maxLength;i++){
                    result+=space;
                }
            }
            return result;
        }
        changePostUser=function(taskSn){
            $("#allUsers").empty();
            $.ajax({
                type: "get",
                url: "/serverestimate/userController/getAllUsers",
                async: true,
                success: function (data) {
                    if(data){
                        var userList = eval('(' + data + ')');
                        for (var i = 0; i < userList.length; i++) {
                            user = userList[i];
                            $("#allUsers").append("<option value='" + user.id + "'>" + formatUserName(user.trueName) + "[" + user.companyName + "]" + "</option>");

                        }
                    }

                },
                error: function (result) {
                    console.log("failed")
                }
            });
            $("#userDialog").show();
            $("#userDialog").dialog({
                height:220,
                width:400,
                resizable: false,
                buttons: {
                    "提交": function() {
                        var json = "{postUser:'" + $("#allUsers").val() + "',taskSn:'" + taskSn + "'}";
                        $.ajax({
                            type: "get",
                            url: "/serverestimate/taskController/updateTaskDealUser",
                            data: {jsonParam: json},
                            async: true,
                            success: function (data) {
                                if(data=='success'){
                                    freshList($("#currentPage").html());
                                    $("#userDialog").dialog( "close" );
                                }else{
                                    showInfoDialog($("#failedDialog"));
                                }
                            },
                            error: function (result) {
                                showInfoDialog($("#failedDialog"));
                            }
                        });

                    },
                    "取消": function() {
                        $("#errorDiv").empty();
                        $( this ).dialog( "close" );
                    }
                }
            });
        }
        urgeAllPostUser=function () {
            if(sourceData){
                var allPostUser=new Array();
                for(var i=0;i<sourceData.length;i++){
                    if(sourceData[i].status&&"0123".indexOf(sourceData[i].status)>0){
                        allPostUser.push(sourceData[i].postUser);
                    }
                }
                emailToUsers(allPostUser,'POST')
            }

        }
        //输入参数是：用户Id数组，类型（提报者/审核者）
        emailToUsers=function(userIdArray,type){
            var param = new Object();
            param["topicId"]=topicId;
            param["userIdArray"]=userIdArray;
            param["type"]=type;
            var obj2json=JSON.stringify(param);
            $.ajax({
                type: "get",
                url: "/serverestimate/topicController/emailToUsers",
                data: {jsonParam: obj2json},
                async: true,
                success: function (data) {
                    if (data&&data=="success") {
                        $("#urgeSuccessDialog").show();
                        $("#urgeSuccessDialog").dialog({
                            height:150,
                            width:300,
                            resizable: false,
                            buttons: {
                                "确定": function() {
                                    $( this ).dialog( "close" );
                                }
                            }
                        });
                    } else {
                        alert("failed")
                    }
                },
                error: function (result) {
                    console.log("failed")
                }
            });
        }
        returnTopicList=function () {
            window.location = 'topicList.html'
        }
    </script>
</head>


<body>
    <div class="toolbar">
        <span><h4>进度详情</h4></span>
    </div>
    <div class="list-button">
        <span class="addBtn" style="width:150px;" onclick="returnTopicList()">返回</span>
        <span class="addBtn" style="width:150px;" onclick="urgeAllCurrentUser()">催办未完成的当前执行人</span>
        <span class="addBtn" style="width:150px;" id="addNew" onclick="urgeAllPostUser()">催办未完成的提报人</span>
    </div>
    <div class="list-table">
        <table width="95%" align="center" >
            <tr >
                <th width="5%">序号</th>
                <th width="25%">分公司</th>
                <th width="10%">提报人</th>
                <th width="10%">当前进度</th>
                <th width="10%">当前执行人</th>
                <th width="35%">操作</th>
            </tr>
            <tbody id="tbMain">
            </tbody>
        </table>
    </div>

    <div id="confirmDialog" style="display:none;" title="系统提示">
        <p id="confirmInfo" align="center">确定催促所有未完成的人吗？</p>
    </div>
    <div id="userDialog" title="人员选择" style="display: none">
        <p>待选人：
            <select id="allUsers" name="allUsers" style="width: 200px;height: 30px;"></select>
        </p>
    </div>
    <div id="failedDialog" style="display:none;" title="系统提示">
        <p align="center">操作失败，请联系管理员！</p>
    </div>
    <div id="urgeSuccessDialog" style="display:none;" title="系统提示">
        <p align="center">提醒成功！</p>
    </div>
</body>
</html>
